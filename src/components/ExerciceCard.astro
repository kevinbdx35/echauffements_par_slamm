---
type VideoEntry = string | { id: string; start?: number };

interface Props {
  numero: number;
  titre: string;
  description: string;
  youtubeIds: VideoEntry[];
  duree: string;
}
const { numero, titre, description, youtubeIds, duree } = Astro.props;
const videos = youtubeIds
  .map(v => typeof v === 'string' ? { id: v, start: undefined } : v)
  .filter(v => v.id.trim() !== '');

const principale = videos[0];
---

<div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700">
  <div class="p-3 flex items-center gap-3">
    <span class="text-5xl font-black text-red-500 leading-none shrink-0 w-14 text-center">
      {String(numero).padStart(2, '0')}
    </span>
    <div class="flex-1 min-w-0">
      <h3 class="text-white font-bold text-base leading-tight">{titre}</h3>
      {description && (
        <p class="text-gray-400 text-sm mt-0.5">{description}</p>
      )}
    </div>
    {duree && (
      <span class="shrink-0 text-xs font-semibold text-red-400 bg-red-500/10 px-2 py-1 rounded-full">
        {duree}
      </span>
    )}
  </div>
  {videos.length > 0 ? (
    <div class="px-3 pb-3 flex flex-col gap-2">
      <div
        class="main-video aspect-video w-full rounded-xl overflow-hidden shadow-lg relative cursor-pointer ring-4 ring-red-500"
        data-video-id={principale.id}
        data-video-start={principale.start ?? ''}
      >
        <img
          src={`https://img.youtube.com/vi/${principale.id}/hqdefault.jpg`}
          alt={titre}
          class="w-full h-full object-cover"
          loading="lazy"
        />
        <div class="video-error hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-700 gap-1">
          <span class="text-gray-300 text-sm font-semibold">Vidéo indisponible</span>
          <span class="text-gray-500 text-xs">{principale.id}</span>
        </div>
      </div>
      {videos.length > 1 && (
        <div class="flex gap-2 overflow-x-auto pb-1 mt-2">
          {videos.map((v, i) => (
            <button
              class:list={[
                "comp-thumb shrink-0 w-24 aspect-video rounded-lg overflow-hidden transition-all",
                i === 0 ? "opacity-100" : "opacity-60 hover:opacity-90"
              ]}
              data-video-id={v.id}
              data-video-start={v.start ?? ''}
              data-index={i}
              aria-label={i === 0 ? "Vidéo principale" : `Vidéo complémentaire ${i}`}
            >
              <img
                src={`https://img.youtube.com/vi/${v.id}/mqdefault.jpg`}
                alt={`${titre} — vidéo ${i + 1}`}
                class="w-full h-full object-cover"
                loading="lazy"
              />
            </button>
          ))}
        </div>
      )}
    </div>
  ) : (
    <div class="mx-3 mb-3 rounded-lg bg-gray-700/40 border border-dashed border-gray-600 flex items-center justify-center py-4">
      <span class="text-gray-500 text-xs">Vidéo à venir</span>
    </div>
  )}
</div>

<script>
  function attachMainVideoHandlers(mainEl: HTMLElement) {
    const img = mainEl.querySelector('img');
    if (img) {
      img.addEventListener('error', () => {
        img.classList.add('hidden');
        mainEl.querySelector('.video-error')?.classList.remove('hidden');
        mainEl.classList.remove('cursor-pointer');
        mainEl.dataset.unavailable = 'true';
      });
    }
    mainEl.addEventListener('click', () => {
      if (mainEl.dataset.unavailable || mainEl.querySelector('iframe')) return;
      const id = mainEl.dataset.videoId!;
      const start = mainEl.dataset.videoStart;
      const embedUrl = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1${start ? `&start=${start}` : ''}`;
      const iframe = document.createElement('iframe');
      iframe.src = embedUrl;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.className = 'w-full h-full';
      mainEl.innerHTML = '';
      mainEl.appendChild(iframe);
    });
  }

  document.querySelectorAll('.main-video').forEach(el => {
    attachMainVideoHandlers(el as HTMLElement);
  });

  document.querySelectorAll('.comp-thumb').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('.flex') as HTMLElement;
      const mainEl = row?.parentElement?.querySelector('.main-video') as HTMLElement | null;
      if (!mainEl) return;

      const id = (btn as HTMLElement).dataset.videoId!;
      const start = (btn as HTMLElement).dataset.videoStart ?? '';
      const index = parseInt((btn as HTMLElement).dataset.index ?? '0');

      mainEl.dataset.videoId = id;
      mainEl.dataset.videoStart = start;
      delete mainEl.dataset.unavailable;
      mainEl.classList.add('cursor-pointer');
      mainEl.innerHTML = `
        <img src="https://img.youtube.com/vi/${id}/hqdefault.jpg" alt="" class="w-full h-full object-cover" />
        <div class="video-error hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-700 gap-1">
          <span class="text-gray-300 text-sm font-semibold">Vidéo indisponible</span>
          <span class="text-gray-500 text-xs">${id}</span>
        </div>
      `;
      attachMainVideoHandlers(mainEl);

      // Border rouge si principale, grise si secondaire
      if (index === 0) {
        mainEl.classList.remove('ring-gray-600');
        mainEl.classList.add('ring-red-500');
      } else {
        mainEl.classList.remove('ring-red-500');
        mainEl.classList.add('ring-gray-600');
      }

      // Highlight miniature active
      row.querySelectorAll('.comp-thumb').forEach(t => {
        t.classList.remove('opacity-100');
        t.classList.add('opacity-60');
      });
      btn.classList.remove('opacity-60');
      btn.classList.add('opacity-100');
    });
  });
</script>
