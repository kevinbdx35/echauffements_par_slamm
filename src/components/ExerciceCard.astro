---
import YouTubeEmbed from './YouTubeEmbed.astro';

type VideoEntry = string | { id: string; start?: number };

interface Props {
  numero: number;
  titre: string;
  description: string;
  youtubeIds: VideoEntry[];
  duree: string;
}
const { numero, titre, description, youtubeIds, duree } = Astro.props;
const videos = youtubeIds
  .map(v => typeof v === 'string' ? { id: v, start: undefined } : v)
  .filter(v => v.id.trim() !== '');

const principale = videos[0];
const complementaires = videos.slice(1);
---

<div class="bg-gray-800 rounded-xl overflow-hidden border border-gray-700">
  <div class="p-3 flex items-center gap-3">
    <span class="text-5xl font-black text-red-500 leading-none shrink-0 w-14 text-center">
      {String(numero).padStart(2, '0')}
    </span>
    <div class="flex-1 min-w-0">
      <h3 class="text-white font-bold text-base leading-tight">{titre}</h3>
      {description && (
        <p class="text-gray-400 text-sm mt-0.5">{description}</p>
      )}
    </div>
    {duree && (
      <span class="shrink-0 text-xs font-semibold text-red-400 bg-red-500/10 px-2 py-1 rounded-full">
        {duree}
      </span>
    )}
  </div>
  {videos.length > 0 ? (
    <div class="px-3 pb-3 flex flex-col gap-2">
      <div class="flex flex-col gap-1">
        <span class="text-xs font-semibold text-red-400 uppercase tracking-wider">Principale</span>
        <YouTubeEmbed youtubeId={principale.id} titre={titre} start={principale.start} />
      </div>
      {complementaires.length > 0 && (
        <div>
          <button
            class="voir-aussi-btn mt-1 flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-300 transition-colors"
            aria-expanded="false"
          >
            <span class="voir-aussi-chevron transition-transform duration-200">▶</span>
            <span>Voir aussi ({complementaires.length})</span>
          </button>
          <div class="voir-aussi-container hidden flex flex-col gap-3 mt-2">
            {complementaires.map(v => (
              <YouTubeEmbed youtubeId={v.id} titre={titre} start={v.start} />
            ))}
          </div>
        </div>
      )}
    </div>
  ) : (
    <div class="mx-3 mb-3 rounded-lg bg-gray-700/40 border border-dashed border-gray-600 flex items-center justify-center py-4">
      <span class="text-gray-500 text-xs">Vidéo à venir</span>
    </div>
  )}
</div>

<script>
  document.querySelectorAll('.voir-aussi-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const container = btn.nextElementSibling as HTMLElement;
      const chevron = btn.querySelector('.voir-aussi-chevron') as HTMLElement;
      const isOpen = !container.classList.contains('hidden');
      container.classList.toggle('hidden', isOpen);
      chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
      btn.setAttribute('aria-expanded', String(!isOpen));
    });
  });
</script>
